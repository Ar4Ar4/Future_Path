<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
   <head>
      <meta charset="UTF-8">
      <title>FuturePath | Assessment</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
      <link rel="stylesheet" th:href="@{/css/common.css}" />
      <link rel="stylesheet" th:href="@{/css/assessment.css}" />
   </head>
   <body>
      <nav th:replace="~{sidebar :: sidebar}"></nav>
      <main>
		  
         <nav th:replace="~{header :: header}"></nav>
         <hr>
         <nav class="sub-header">
            <div>
          	  <span class="crumb">FuturePath</span>
			  <i class="fa-solid fa-chevron-right separator"></i>
    	      <span class="crumb active">ASSESSMENT</span>
          </div>
            <div class="btn-group">
            </div>
         </nav>
         <hr>
         <div class="content">
			 
            <div class="assessment-container" th:if="${questionDto.questions != null and !#lists.isEmpty(questionDto.questions)}">
               <!-- Question Navigation -->
               <div class="question-nav">
                  <h3>Questions</h3>
                  <div class="question-list" id="questionList">
                     <button th:each="question, iterStat : ${questionDto.questions}"
                        type="button"
                        th:text="${iterStat.index + 1}"
                        th:attr="data-question=${iterStat.index + 1}">
                     </button>
                  </div>
               </div>
               <!-- Assessment Form -->
               <form th:action="@{/assessment/result}" method="POST" th:object="${assessmentDto}" class="assessment-form">
                  <input type="hidden" name="mode" th:value="${mode}" />                
                  <input type="hidden" name="answeredJson" id="answeredJson" />
                  <div class="question-card" th:each="question, iterStat : ${questionDto.questions}">
                     <div class="message">
                        <strong th:text="${iterStat.index + 1} + '. ' + ${question.question}">1. Sample question text</strong><br>
                        <span>Select the most appropriate answer.</span>
                     </div>
                     <div class="choices">
                        <button type="button" name="q1" th:each="answer : ${question.answers}" 
                           th:text="${answer.answer}" th:data-answer-id="${answer.answerIdPk}">
                        Choice
                        </button>
                     </div>
                  </div>
                  <button type="submit" class="submit-btn transitioning" id="submitAssessmentBtn">
                  <i class="fa-solid fa-paper-plane"></i> Submit Assessment
                  </button>
               </form>
               <div class="progress-container">
				    <div class="progress-bar">
					    <div class="progress-fill"></div>
					</div>
				    <span class="progress-text">0 / 0 answered</span>
				</div>
               <button id="backToTopBtn" title="Back to Top">
               <i class="fa-solid fa-chevron-up"></i>
               </button>
            </div>
            <div th:if="${questionDto.questions == null or #lists.isEmpty(questionDto.questions)}" class="no-questions" 
               style="margin: auto; text-align: center;">
               <p>No Questions Right Now.</p>
               <a th:href="@{/dashboard}" class="btn-back-dashboard">Back to Assessment</a>
            </div>
         </div>
         <nav class="footer">
			<div>
				<span>All rights reserved by FuturePath</span>
			</div>
			<div class="terms">
				<span>Terms of Use</span>
				<span>Privacy Policy</span>
				<span>Contact us</span>
			</div>
		</nav>
		<!-- Unfilled Fields Modal -->
         <div id="unfilledModal" class="themed-modal-overlay">
    <div class="themed-modal-box">
        <h3>Incomplete Assessment</h3>
        <p>Please answer all questions before submitting.</p>
        <div class="themed-modal-actions">
            <button class="modal-btn" onclick="closeUnfilledModal()">OK</button>
        </div>
    </div>
</div>

      </main>
      <script th:src="@{/script/loading.js}"></script>
      <script th:inline="javascript">
         document.addEventListener("DOMContentLoaded", () => {
    const webDto = /*[[${questionDto}]]*/ {};
    const questionCards = document.querySelectorAll(".question-card");
    const questionNavBtns = document.querySelectorAll(".question-list button");
    const backToTopBtn = document.getElementById("backToTopBtn");
    const answeredInput = document.getElementById("answeredJson"); // hidden input

    const questionAnswers = {};

    // Initialize questionAnswers
    questionCards.forEach((card, index) => {
        const choices = card.querySelectorAll(".choices button");
        const questionIdPk = webDto.questions[index]?.idPk;
        questionAnswers[questionIdPk] = null;

        choices.forEach(choice => {
            choice.addEventListener("click", () => {
                choices.forEach(btn => btn.classList.remove("selected"));
                choice.classList.add("selected");

                const answerIdPk = choice.getAttribute("data-answer-id");
                questionAnswers[questionIdPk] = parseInt(answerIdPk);

                questionNavBtns[index].classList.add("answered");

                // Update hidden input field
                answeredInput.value = JSON.stringify(questionAnswers);

                updateProgress();
            });
        });
    });

    // Scroll button logic
    window.addEventListener("scroll", () => {
        backToTopBtn.style.display = window.scrollY > 300 ? "block" : "none";
    });

    questionNavBtns.forEach((btn, index) => {
        btn.addEventListener("click", () => {
            const questionCard = questionCards[index];
            if (questionCard) {
                questionCard.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    });

    backToTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Progress bar logic
    const totalQuestions = webDto.questions.length;
    const progressFill = document.querySelector(".progress-fill");
    const progressText = document.querySelector(".progress-text");
    progressText.textContent = `0 / ${totalQuestions} answered`;

    function updateProgress() {
        const answeredCount = Object.values(questionAnswers).filter(v => v !== null).length;
        const percent = (answeredCount / totalQuestions) * 100;

        progressFill.style.width = percent + "%";
        progressText.textContent = `${answeredCount} / ${totalQuestions} answered`;
    }
    
       // === UNFILLED MODAL LOGIC ===
// === UNFILLED MODAL LOGIC ===
window.openUnfilledModal = function() {
    document.getElementById("unfilledModal").style.display = "flex";
};

window.closeUnfilledModal = function() {
    document.getElementById("unfilledModal").style.display = "none";
};

    // Add form submit validation
    const form = document.querySelector(".assessment-form");
    form.addEventListener("submit", function(e) {
        let incompleteFound = false;

        // Check for unanswered questions
        if (Object.values(questionAnswers).some(v => v === null)) {
            incompleteFound = true;
        }

        if (incompleteFound) {
            e.preventDefault();
            openUnfilledModal();
            removeLoadingScreenBody();
        }
    });

 
});


         
      </script>
   </body>
</html>